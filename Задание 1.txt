CREATE TABLE REF_DEVICE 
(
  ID              NUMBER(10, 0) NOT NULL,
  SERIAL_NUMBER   NVARCHAR2(50) NOT NULL,
  NAME            NVARCHAR2(50),
  DESCRIPTION     NVARCHAR2(150),
  CONSTRAINT PK_REF_DEVICE_ID PRIMARY KEY (ID),
  CONSTRAINT KEY_REF_DEVICE_SERIAL_NUMBER UNIQUE (SERIAL_NUMBER)
);

CREATE TABLE DEVICE_USAGE (
  ID            NUMBER(10, 0) NOT NULL,
  REF_DEVICE_ID NUMBER(10, 0) NOT NULL,
  BRIGADE_CODE  NUMBER(10, 0) NOT NULL,
  USAGE_DATE    DATE          NOT NULL,
  CONSTRAINT PK_DEVICE_USAGE_ID PRIMARY KEY (ID),
  CONSTRAINT FK_DEVICE_USAGE_REF_DEVICE_ID FOREIGN KEY (REF_DEVICE_ID) REFERENCES REF_DEVICE (ID),
  CONSTRAINT KEY_DEVICE_USAGE UNIQUE (BRIGADE_CODE, USAGE_DATE, REF_DEVICE_ID)
);

CREATE TABLE LISTCODE (
  ID                   NUMBER(10, 0) NOT NULL,
  DEVICE_SERIAL_NUMBER NVARCHAR2(50) NOT NULL,
  CHANNEL_ID           NUMBER(10, 0) NOT NULL,
  PDT                  DATE          NOT NULL,
  BRIGADE_CODE         NUMBER(10, 0) NOT NULL,
  WORK_CODE            NUMBER(10, 0) NOT NULL,
  CONSTRAINT PK_LISTCODE_ID PRIMARY KEY (ID),
  CONSTRAINT KEY_LISTCODE UNIQUE (DEVICE_SERIAL_NUMBER, CHANNEL_ID, PDT, BRIGADE_CODE, WORK_CODE)
);


INSERT INTO REF_DEVICE (ID, SERIAL_NUMBER, NAME, DESCRIPTION)
VALUES (1, '123', 'Device_1', 'Description device_1');
INSERT INTO REF_DEVICE (ID, SERIAL_NUMBER, NAME, DESCRIPTION)
VALUES (2, '124', 'Device_2', 'Description device_2 ');
INSERT INTO REF_DEVICE (ID, SERIAL_NUMBER, NAME, DESCRIPTION)
VALUES (3, '125', 'Device_3', 'Description device_3');




INSERT INTO LISTCODE (ID, DEVICE_SERIAL_NUMBER, CHANNEL_ID, PDT, BRIGADE_CODE, WORK_CODE)
VALUES (1, '123', 1, TO_DATE('2020-06-01', 'yyyy-mm-dd'), 1, 100);
INSERT INTO LISTCODE (ID, DEVICE_SERIAL_NUMBER, CHANNEL_ID, PDT, BRIGADE_CODE, WORK_CODE)
VALUES (2, '123', 1, TO_DATE('2020-06-16', 'yyyy-mm-dd'), 1, 101);
INSERT INTO LISTCODE (ID, DEVICE_SERIAL_NUMBER, CHANNEL_ID, PDT, BRIGADE_CODE, WORK_CODE)
VALUES (3, '124', 1, TO_DATE('2020-06-18', 'yyyy-mm-dd'), 3, 104);
INSERT INTO LISTCODE (ID, DEVICE_SERIAL_NUMBER, CHANNEL_ID, PDT, BRIGADE_CODE, WORK_CODE)
VALUES (4, '125', 1, TO_DATE('2020-06-19', 'yyyy-mm-dd'), 4, 105);


INSERT INTO DEVICE_USAGE (ID, REF_DEVICE_ID, BRIGADE_CODE, USAGE_DATE)
VALUES (1, 1, 1, TO_DATE('2020-06-01', 'yyyy-mm-dd'));

SELECT * FROM LISTCODE;
SELECT * FROM REF_DEVICE;
SELECT * FROM DEVICE_USAGE;


SELECT LISTCODE.BRIGADE_CODE, LISTCODE.PDT, REF_DEVICE.ID
FROM LISTCODE
LEFT JOIN DEVICE_USAGE ON LISTCODE.BRIGADE_CODE = DEVICE_USAGE.BRIGADE_CODE
AND LISTCODE.PDT = DEVICE_USAGE.USAGE_DATE
AND DEVICE_USAGE.USAGE_DATE BETWEEN TO_DATE('2020-06-01', 'yyyy-mm-dd') AND TO_DATE('2020-06-30', 'yyyy-mm-dd')
LEFT JOIN REF_DEVICE ON REF_DEVICE.SERIAL_NUMBER = LISTCODE.DEVICE_SERIAL_NUMBER
WHERE DEVICE_USAGE.BRIGADE_CODE IS NULL;

